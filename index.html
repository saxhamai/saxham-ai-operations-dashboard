<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Daily Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ---------- VARIABLES & RESET ---------- */
:root {
  --primary: #0056b3; 
  --bg-body: #f4f6f9;
  --bg-card: #ffffff;
  --text-main: #212529;
  --text-muted: #6c757d;
  --border: #dee2e6;
  
  --success: #28a745;
  --warning: #ffc107;
  --danger: #dc3545;
  --info: #17a2b8;

  --shadow: 0 4px 6px rgba(0,0,0,0.05);
  --radius: 8px;
  
  --header-bg: #1e293b; 
  --header-text: #ffffff;
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-body);
  color: var(--text-main);
  margin: 0;
  padding: 0;
  padding-bottom: 60px;
}

/* ---------- HEADER ---------- */
.dashboard-header {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  padding: 12px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: var(--header-text);
}

.brand-container {
  display: flex;
  align-items: center;
  gap: 15px;
}

.brand-logo {
  height: 48px;
  width: auto;
  border-radius: 6px;
  background: #fff;
  padding: 2px;
  box-shadow: 0 0 10px rgba(255,255,255,0.2);
}

.brand-info { display: flex; flex-direction: column; }

.brand-name {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(90deg, #60a5fa, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-transform: uppercase;
}

.brand-tagline { font-size: 11px; opacity: 0.8; color: #cbd5e1; }

.page-title-badge {
  background: rgba(255,255,255,0.1);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  border: 1px solid rgba(255,255,255,0.1);
  margin-left: 15px;
  display: none;
}
@media (min-width: 600px) { .page-title-badge { display: inline-block; } }

.header-right { display: flex; align-items: center; gap: 15px; }

.date-display { text-align: right; font-size: 12px; }
.date-main { font-weight: 600; color: #fff; }
.status-indicator { font-weight: 700; }

.header-btn-group { display: flex; gap: 10px; }

.btn-header {
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.05);
  color: #fff;
  padding: 8px 14px;
  font-size: 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-header:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
.btn-header.reset:hover { background: rgba(220, 53, 69, 0.2); border-color: #dc3545; color: #ff8787; }

/* ---------- PROGRESS WIDGET ---------- */
.progress-widget {
  background: var(--bg-card);
  margin: 20px;
  padding: 20px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.progress-header { display: flex; justify-content: space-between; font-size: 14px; font-weight: 600; }
.progress-track { background: #e9ecef; border-radius: 10px; height: 10px; overflow: hidden; }
.progress-fill { background: linear-gradient(90deg, var(--primary), var(--info)); height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

/* ---------- MAIN LAYOUT ---------- */
#container { padding: 0 20px; max-width: 1400px; margin: 0 auto; }
.section { margin-bottom: 40px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
.section-header h2 { font-size: 16px; text-transform: uppercase; color: var(--text-muted); margin: 0; }
.section-stats { font-size: 12px; font-weight: 600; background: #e2e6ea; padding: 4px 8px; border-radius: 4px; }

/* ---------- CARDS ---------- */
.cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
.process-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; transition: transform 0.2s; display: flex; flex-direction: column; }
.process-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
.process-card.done { border-top: 4px solid var(--success); }
.process-card.pending { border-top: 4px solid var(--warning); }
.process-card.issue { border-top: 4px solid var(--danger); }

.card-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: flex-start; }
.card-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.card-time { font-size: 11px; color: var(--text-muted); background: #f8f9fa; padding: 3px 6px; border-radius: 4px; border: 1px solid #e9ecef; white-space: nowrap; }

.card-body { padding: 15px; flex-grow: 1; font-size: 13px; color: #495057; }

/* CHECKBOXES */
.check-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.1s; }
.check-item:hover { background: #f8f9fa; }
.check-item input[type="checkbox"] { margin-top: 3px; cursor: pointer; accent-color: var(--success); width: 16px; height: 16px; }
.check-item span { flex: 1; }

.check-progress-text {
  font-size: 11px;
  color: var(--primary);
  font-weight: 700;
  margin-bottom: 10px;
  display: inline-block;
  background: #eef4fc;
  padding: 3px 8px;
  border-radius: 12px;
}

.card-footer { padding: 15px; background: #fdfdfd; border-top: 1px solid #f0f0f0; }
.form-group { margin-bottom: 10px; }
.form-control { width: 100%; padding: 8px; font-size: 13px; border: 1px solid var(--border); border-radius: 4px; background: #fff; }
.form-control:disabled { background: #e9ecef; cursor: not-allowed; opacity: 0.7; }

.status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-left: auto; }
.badge-done { background: #d4edda; color: #155724; }
.badge-pending { background: #fff3cd; color: #856404; }
.badge-issue { background: #f8d7da; color: #721c24; }

.submit-wrapper { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
.btn { border: none; padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 4px; cursor: pointer; transition: 0.2s;}
.btn-success { background: var(--success); color: white; }
.btn-disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; }
.btn-primary { background: var(--primary); color: white; }

.final-action-area { text-align: center; padding: 30px; }
.final-btn { padding: 12px 30px; font-size: 16px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,64,133,0.3); }

/* Inactive close button style */
.final-btn.inactive {
  opacity: 0.5;
  background-color: #6c757d;
  cursor: pointer;
}

@media (max-width: 768px) {
  .dashboard-header { flex-direction: column; align-items: flex-start; gap: 15px; }
  .header-right { width: 100%; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
}
</style>
</head>

<body>

<header class="dashboard-header">
  <div class="brand-container">
    <img src="Logo.png" alt="SaXhamAI" class="brand-logo" onerror="this.style.display='none'">
    <div class="brand-info">
      <span class="brand-name">SaXhamAI</span>
      <span class="brand-tagline">Created by Nitin Pawar</span>
    </div>
    <span class="page-title-badge" style="display: flex; align-items: center; gap: 5px;">
      üìã Operations <span style="font-size:10px; margin-left:5px; opacity:0.8; border-left:1px solid rgba(255,255,255,0.3); padding-left:8px;"> 
      <span style="color:#ff8787">*</span> = Required to Close Day
      </span>
    </span>
  </div>

  <div class="header-right">
    <div class="date-display">
      <div class="date-main" id="todayDate"></div>
      <div id="dayStatus" class="status-indicator"></div>
    </div>
    <div class="header-btn-group">
      <button class="btn-header" onclick="goToReport()">üìä Reports</button>
      <button class="btn-header reset" onclick="resetToday()">üîÅ Reset</button>
    </div>
  </div>
</header>

<div class="progress-widget">
  <div class="progress-header">
    <span>Overall Completion</span>
    <span id="overallLabel">0%</span>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="overallBar"></div>
  </div>
</div>

<div id="container"></div>

<div class="final-action-area">
  <button id="closeBtn" class="btn btn-primary final-btn" onclick="closeDay()">‚úÖ Close Operations Day</button>
</div>

<script src="js/data.js"></script>

<script>
const d = new Date();
const today = d.toISOString().split("T")[0];
const storageKey = "daily_" + today;
const closeKey = "dayClosed_" + today;

document.getElementById("todayDate").innerText = today;

function updateDayStatus() {
  const closed = localStorage.getItem(closeKey);
  const statusDiv = document.getElementById("dayStatus");
  const btn = document.getElementById("closeBtn");

  if (closed) {
    statusDiv.innerHTML = `<span style="color:#ff8787">üîí Closed at ${closed}</span>`;
    btn.innerText = "üîí Day Closed";
    btn.classList.add("btn-disabled");
    btn.classList.remove("btn-primary");
    btn.disabled = true;
  } else {
    statusDiv.innerHTML = `<span style="color:#4ade80">‚óè Live / Active</span>`;
  }
}

function updateOverallProgress(data) {
  const total = processes.length;
  const done = Object.keys(data).length;
  const percent = Math.round((done / total) * 100);

  document.getElementById("overallLabel").innerText = `${done}/${total} (${percent}%)`;
  document.getElementById("overallBar").style.width = percent + "%";
}

// ----- CHECKBOX HANDLER -----
function handleCheckClick(id, total) {
  let count = 0;
  let checkedIndices = [];

  for(let i=0; i<total; i++) {
    const chk = document.getElementById(`chk_${id}_${i}`);
    if(chk && chk.checked) {
      count++;
      checkedIndices.push(i);
    }
  }

  // Save checked state
  localStorage.setItem(`temp_chk_${today}_${id}`, JSON.stringify(checkedIndices));

  // Update Progress Text
  const progText = document.getElementById(`prog_${id}`);
  if(progText) progText.innerText = `‚úî ${count} / ${total} checks completed`;

  // Auto-Select DONE
  const statusBox = document.getElementById(`status_${id}`);
  if(count === total && statusBox && !statusBox.disabled) {
    statusBox.value = "DONE";
  }
}

// ----- CLOSE BUTTON VISUAL LOGIC -----
function updateCloseButtonState(data) {
  if (localStorage.getItem(closeKey)) return;

  const required = processes.filter(p => p.dayCloseRequired);
  const allDone = required.every(p => data[p.id]);
  const btn = document.getElementById("closeBtn");

  if (!allDone) {
    btn.classList.add("inactive");
    btn.title = "Complete all mandatory tasks to close the day";
    btn.innerText = "‚è≥ Tasks Pending";
  } else {
    btn.classList.remove("inactive");
    btn.title = "All mandatory tasks complete. Ready to close.";
    btn.innerText = "‚úÖ Close Operations Day";
  }
}

function render() {
  const data = JSON.parse(localStorage.getItem(storageKey) || "{}");
  updateOverallProgress(data);
  updateDayStatus();
  updateCloseButtonState(data);

  const container = document.getElementById("container");
  container.innerHTML = "";

  ["BOD","CONTINUOUS","EOD"].forEach(cat => {
    const sectionProcs = processes.filter(p => p.category === cat);
    const doneCount = sectionProcs.filter(p => data[p.id]).length;

    const section = document.createElement("div");
    section.className = "section";
    
    const headerHTML = `
      <div class="section-header">
        <h2>${cat} Operations</h2>
        <span class="section-stats">${doneCount} / ${sectionProcs.length} Done</span>
      </div>
    `;
    
    const gridDiv = document.createElement("div");
    gridDiv.className = "cards-grid";

    sectionProcs.forEach(p => {
      const saved = data[p.id];
      const statusClass = saved ? saved.status.toLowerCase() : "pending";
      
      const card = document.createElement("div");
      card.className = "process-card " + statusClass;

      // NEW: Add Red Asterisk if Mandatory
      const mandatoryMark = p.dayCloseRequired 
        ? `<span style="color:var(--danger); margin-left:4px; font-weight:bold;" title="Mandatory for Day Close">*</span>` 
        : "";

      // Load Saved Temp Checks if not submitted
      let savedIndices = [];
      if (!saved) {
        savedIndices = JSON.parse(localStorage.getItem(`temp_chk_${today}_${p.id}`) || "[]");
      }

      // Checkbox Logic
      const checksHTML = p.checks.map((c, idx) => {
        const isChecked = saved ? true : savedIndices.includes(idx);
        return `
        <label class="check-item">
          <input type="checkbox" id="chk_${p.id}_${idx}" 
            ${isChecked ? "checked" : ""} 
            ${saved ? "disabled" : ""} 
            onclick="handleCheckClick('${p.id}', ${p.checks.length})">
          <span>${c}</span>
        </label>
      `}).join("");

      const currentCount = saved ? p.checks.length : savedIndices.length;

      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">${p.name} ${mandatoryMark}</div>
            <div class="card-time">‚è∞ ${p.timeWindow}</div>
          </div>
          ${saved ? `<span class="status-badge badge-${statusClass}">‚úî ${saved.status}</span>` : ''}
        </div>

        <div class="card-body">
          <span class="check-progress-text" id="prog_${p.id}">
             ‚úî ${currentCount} / ${p.checks.length} checks completed
          </span>
          ${checksHTML}
        </div>

        <div class="card-footer">
          <div class="form-group">
             <select id="status_${p.id}" class="form-control" ${saved ? "disabled" : ""}>
              <option value="">-- Select Status --</option>
              <option value="DONE">Done</option>
              <option value="PENDING">Pending</option>
              <option value="ISSUE">Issue</option>
            </select>
          </div>
          <div class="form-group">
            <textarea id="remark_${p.id}" class="form-control" placeholder="Add remarks..." ${saved ? "disabled" : ""}></textarea>
          </div>
          
          <input type="file" id="file_${p.id}" ${saved ? "disabled" : ""} />

          <div class="submit-wrapper">
            <button class="btn ${saved ? "btn-disabled" : "btn-success"}"
              style="width:100%"
              ${saved ? "disabled" : ""}
              onclick="submitProcess('${p.id}', this)">
              ${saved ? "Submitted" : "Submit Update"}
            </button>
          </div>
        </div>
      `;

      if (saved) {
        setTimeout(() => {
          document.getElementById(`status_${p.id}`).value = saved.status;
          document.getElementById(`remark_${p.id}`).value = saved.remark || "";
        }, 0);
      }

      gridDiv.appendChild(card);
    });

    section.innerHTML = headerHTML;
    section.appendChild(gridDiv);
    container.appendChild(section);
  });
}

// ----- SUBMIT LOGIC WITH DOUBLE-CLICK PREVENTION -----
function submitProcess(id, btn) {
  // 1. Double Submit Prevention
  if(btn) {
    btn.disabled = true;
    btn.innerText = "Saving...";
  }

  const p = processes.find(x => x.id === id);
  const statusBox = document.getElementById("status_" + id);
  const status = statusBox.value;
  const remark = document.getElementById("remark_" + id).value.trim();
  const file = document.getElementById("file_" + id).files.length;

  // Helper to reset button if validation fails
  const resetBtn = () => {
    if(btn) {
      btn.disabled = false;
      btn.innerText = "Submit Update";
    }
  };

  if (!status) {
    alert("Please select a Status.");
    resetBtn();
    return;
  }
  if ((status !== "DONE") && !remark) {
    alert("Remarks are mandatory for Pending/Issue.");
    resetBtn();
    return;
  }
  if (status === "ISSUE" && file === 0) {
    alert("Screenshot is mandatory for Issues.");
    resetBtn();
    return;
  }

  const totalChecks = p.checks.length;
  let checkedCount = 0;
  for(let i=0; i<totalChecks; i++) {
    const chk = document.getElementById(`chk_${id}_${i}`);
    if (chk && chk.checked) checkedCount++;
  }

  if (status === "DONE" && checkedCount < totalChecks) {
    alert("‚ùå You cannot mark as DONE until all checklist steps are ticked.");
    resetBtn();
    return;
  }

  // Cleanup temp storage after successful submit
  localStorage.removeItem(`temp_chk_${today}_${id}`);

  const data = JSON.parse(localStorage.getItem(storageKey) || "{}");
  data[id] = { status, remark, submittedAt: new Date().toLocaleString() };

  localStorage.setItem(storageKey, JSON.stringify(data));
  location.reload();
}

function closeDay() {
  const btn = document.getElementById("closeBtn");
  
  // 1. Inactive Click Guard
  if (btn.classList.contains("inactive")) {
    return alert("‚ö†Ô∏è Cannot Close Day yet!\n\nPlease complete all mandatory BOD and EOD tasks marked with '*' to proceed.");
  }

  // 2. Data Integrity Guard
  const data = JSON.parse(localStorage.getItem(storageKey) || "{}");
  const required = processes.filter(p => p.dayCloseRequired).map(p => p.id);

  if (!required.every(id => data[id])) {
    return alert("System Error: Mandatory data missing.");
  }

  localStorage.setItem(closeKey, new Date().toLocaleTimeString());
  location.reload();
}

function resetToday() {
  if (!confirm("Reset today?")) return;
  
  localStorage.removeItem(storageKey);
  localStorage.removeItem(closeKey);
  
  // Clear all temp checks for today
  processes.forEach(p => {
    localStorage.removeItem(`temp_chk_${today}_${p.id}`);
  });

  location.reload();
}

function goToReport() {
  window.location.href = "history.html";
}

render();
</script>

</body>
</html>

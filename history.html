<script src="js/data.js"></script>
<script>
/* ======================================================
   INIT DATE
   ====================================================== */
function setToday() {
  const d = new Date();
  document.getElementById("historyDate").value = d.toISOString().split("T")[0];
}

/* ======================================================
   LOAD HISTORY (SINGLE SOURCE OF TRUTH)
   ====================================================== */
function loadHistory() {
  const date = document.getElementById("historyDate").value;
  const container = document.getElementById("historyContainer");
  container.innerHTML = "";

  if (!date) {
    alert("Please select a date");
    return;
  }

  /* ---- STORAGE KEYS (MATCH INDEX.HTML) ---- */
  const STORAGE = {
    DAILY: `daily_${date}`,
    PARTIAL_BOD: `partialBOD_${date}`,
    OTHER_TASKS: `otherTasks_${date}`,
    DAY_CLOSED: `dayClosed_${date}`
  };

  const dailyRaw = localStorage.getItem(STORAGE.DAILY);
  const snapshotRaw = localStorage.getItem(STORAGE.PARTIAL_BOD);
  const closedAt = localStorage.getItem(STORAGE.DAY_CLOSED);

  let hasAnyData = false;

  /* ======================================================
     1Ô∏è‚É£ PARTIAL BOD SNAPSHOT (ALWAYS SHOW IF EXISTS)
     ====================================================== */
  if (snapshotRaw) {
    hasAnyData = true;
    const snap = JSON.parse(snapshotRaw);

    const snapDiv = document.createElement("div");
    snapDiv.className = "snapshot-card";
    snapDiv.innerHTML = `
      <div class="snapshot-badge">Checkpoint</div>
      <div class="snapshot-title">
        <span>üì∏ BOD Checkpoint Snapshot</span>
        <span style="font-size:12px;">Captured: ${snap.time}</span>
      </div>
      <span class="snapshot-note">
        Informational ‚Äì snapshot shows BOD status at that moment only.
      </span>

      <div style="font-size:13px; margin-bottom:8px;">
        <strong style="color:var(--success)">‚úÖ Completed:</strong>
        ${snap.completed.length ? snap.completed.join(", ") : "None"}
      </div>

      <div style="font-size:13px;">
        <strong style="color:var(--danger)">‚è≥ Pending:</strong>
        ${snap.pending.length ? snap.pending.join(", ") : "None"}
      </div>
    `;
    container.appendChild(snapDiv);
  }

  /* ======================================================
     2Ô∏è‚É£ DAY STILL ACTIVE BANNER
     ====================================================== */
  if (!closedAt) {
    const banner = document.createElement("div");
    banner.className = "alert alert-info";
    banner.innerHTML = `
      <strong>Day is still active.</strong><br>
      <small>
        Snapshot & live progress are visible.  
        Final report will be locked after day closure.
      </small>
    `;
    container.appendChild(banner);
  }

  /* ======================================================
     3Ô∏è‚É£ PROCESS HISTORY (LIVE OR FINAL)
     ====================================================== */
  if (dailyRaw) {
    hasAnyData = true;
    const records = JSON.parse(dailyRaw);

    /* ---- SHOW FINAL SUMMARY ONLY IF DAY CLOSED ---- */
    if (closedAt) {
      const total = processes.length;
      const done = Object.keys(records).length;
      const percent = Math.round((done / total) * 100);

      const summary = document.createElement("div");
      summary.className = "summary-widget";
      summary.innerHTML = `
        <div class="summary-header">
          <span>Final Daily Summary</span>
          <span>${done} / ${total} (${percent}%)</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" style="width:${percent}%"></div>
        </div>
        <div style="margin-top:15px; font-size:12px; text-align:right; color:var(--text-muted); border-top:1px solid #f0f0f0; padding-top:10px;">
          üîí Day Closed at <strong>${closedAt}</strong>
        </div>
      `;
      container.appendChild(summary);
    }

    /* ---- CATEGORY SECTIONS ---- */
    ["BOD", "CONTINUOUS", "EOD"].forEach(category => {
      const list = processes.filter(p => p.category === category);
      const submitted = list.filter(p => records[p.id]).length;
      if (submitted === 0) return;

      const sec = document.createElement("div");
      sec.className = "section";
      sec.innerHTML = `
        <div class="section-header">
          <span class="section-title">${category} Operations</span>
          <span style="font-size:11px; font-weight:700;">
            ${submitted}/${list.length} DONE
          </span>
        </div>
      `;

      list.forEach(p => {
        const r = records[p.id];
        if (!r) return;

        const card = document.createElement("div");
        card.className = `history-card ${r.status}`;
        card.innerHTML = `
          <div class="card-top">
            <span class="process-name">${p.name}</span>
            <span class="status-badge badge-${r.status}">${r.status}</span>
          </div>
          ${r.remark ? `<div class="remark-text">üìù ${r.remark}</div>` : ""}
          <div class="timestamp">üïí ${r.submittedAt}</div>
        `;
        sec.appendChild(card);
      });

      container.appendChild(sec);
    });
  }

  /* ======================================================
     4Ô∏è‚É£ AD-HOC TASKS
     ====================================================== */
  const otherRaw = localStorage.getItem(STORAGE.OTHER_TASKS);
  if (otherRaw) {
    const tasks = JSON.parse(otherRaw);
    if (tasks.length) {
      hasAnyData = true;
      const sec = document.createElement("div");
      sec.className = "section";
      sec.innerHTML = `
        <div class="section-header">
          <span class="section-title">üîπ Ad-hoc Tasks</span>
        </div>
      `;

      tasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "history-card DONE";
        div.innerHTML = `
          <div class="card-top">
            <span class="process-name">${t.title}</span>
            <span class="status-badge badge-DONE">DONE</span>
          </div>
          <div class="remark-text">üìù ${t.remark}</div>
          <div class="timestamp">üïí ${t.time}</div>
        `;
        sec.appendChild(div);
      });

      container.appendChild(sec);
    }
  }

  /* ======================================================
     5Ô∏è‚É£ NO DATA FALLBACK
     ====================================================== */
  if (!hasAnyData) {
    container.innerHTML = `
      <div class="alert alert-danger">
        ‚ùå No data available for <strong>${date}</strong>
      </div>
    `;
  }
}

/* ======================================================
   NAV
   ====================================================== */
function goHome() {
  window.location.href = "index.html";
}

/* ======================================================
   INIT
   ====================================================== */
window.onload = function () {
  setToday();
  loadHistory();
};
</script>
